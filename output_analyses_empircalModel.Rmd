---
title: "exploration_empiricalmodelMexicoCity"
author: "Andres Baeza"
date: "April 11, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
require(ggplot2)
require(RColorBrewer)
require(png)
require(grid)
#require(sensitivity)
#require(fmsb)
library(maptools)
require(sp) 
require(rgdal) # requires sp, will use proj.4 if installed
require(plyr)
require(foreign)
require(ggmap)
#<<<<<<< HEAD
library(gridExtra)
#require(scales)
#source("C:/Users/abaezaca/Documents/MEGADAPT/ABM_V2/multiplot_function.R")
#=======
#require(scales)
#source("C:/Users/abaezaca/Documents/MEGADAPT/ABM_V2/multiplot_function.R")
#>>>>>>> c74c88e51d1a64b89da88a3d28c9bf0ff2d08703
```

#ploting water scarcity thresholds and resources/priorities
```{r, echo=FALSE,fig.height=5,fig.width=10}
A<-read.csv(file="C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/concat_output_empirical_antiguedad_scarcity_protestas_C.csv",header = T,skip = 0)
l <- reshape(A, 
  varying = names(A)[35:50],
  v.names = "Scarcity",
  timevar = "Delegation", 
  times = names(A)[35:50], 
  direction = "long")
#names<-c("Azcapotzalco","Coyoac???n","Cuajimalpa","Gustavo A. Madero","Iztacalco","Iztapalapa","Magdalena Contreras","Milpa Alta","???lvaro Obreg???n","Tl???huac","Tlalpan","Xochimilco","Benito Ju???rez","Cuauht???moc","Miguel Hidalgo","Venustiano Carranza")
#ID=c("002","003","004","005","006","007","008","009","010","011","012","013","014","015","016","017")
#g1_d<-subset(l,Recursos_para_distribucion == 350)
 


names<-c("Azcapotzalco","Coyoacán","Cuajimalpa","Gustavo A. Madero","Iztacalco","Iztapalapa","Magdalena Contreras","Milpa Alta","Álvaro Obregón","Tláhuac","Tlalpan","Xochimilco","Benito Juárez","Cuauhtémoc","Miguel Hidalgo","Venustiano Carranza")
ID=c("002","003","004","005","006","007","008","009","010","011","012","013","014","015","016","017")

G1<-ggplot(subset(l,Recursos_para_distribucion == 350),aes(x=Delegation,y=Scarcity,colour=factor(Recursos_para_distribucion)))+geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
   scale_x_discrete(labels=names)+
   scale_y_continuous(name = "scarcity [days w/n water]",limits = c(0, 80))+
   scale_color_discrete(name="Resources ",label="10%")+
   annotate("rect", xmin=0, xmax=18, ymin=0 , ymax=20, alpha=0.1, fill="green")+
   annotate("rect", xmin=0, xmax=18, ymin=20 , ymax=40, alpha=0.1,  fill="blue")+
   annotate("rect", xmin=0, xmax=18, ymin=40 , ymax=60, alpha=0.1,  fill="yellow")+
   annotate("rect", xmin=0, xmax=18, ymin=60 , ymax=80, alpha=0.1, fill="red")
 

G2<-ggplot(subset(l,Recursos_para_distribucion == 983.3333333),aes(x=Delegation,y=Scarcity,colour=factor(Recursos_para_distribucion)))+geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_discrete(labels=names)+
 scale_y_continuous(name = "scarcity [days w/n water]",limits = c(0, 80))+
  scale_color_discrete(name="Resources ",label="25%")+
     annotate("rect", xmin=0, xmax=18, ymin=0 , ymax=20, alpha=0.1, fill="green")+
   annotate("rect", xmin=0, xmax=18, ymin=20 , ymax=40, alpha=0.1,  fill="blue")+
   annotate("rect", xmin=0, xmax=18, ymin=40 , ymax=60, alpha=0.1,  fill="yellow")+   
   annotate("rect", xmin=0, xmax=18, ymin=60 , ymax=80, alpha=0.1, fill="red")
 

G3<-ggplot(subset(l,Recursos_para_distribucion == 1616.666667),aes(x=Delegation,y=Scarcity,colour=factor(Recursos_para_distribucion)))+geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_discrete(labels=names)+
 scale_y_continuous(name = "scarcity [days w/n water]",limits = c(0, 80))+
  scale_color_discrete(name="Resources ",label="50%")+
    annotate("rect", xmin=0, xmax=18, ymin=0 , ymax=20, alpha=0.1, fill="green")+
   annotate("rect", xmin=0, xmax=18, ymin=20 , ymax=40, alpha=0.1,  fill="blue")+
   annotate("rect", xmin=0, xmax=18, ymin=40 , ymax=60, alpha=0.1,  fill="yellow")+   
   annotate("rect", xmin=0, xmax=18, ymin=60 , ymax=80, alpha=0.1, fill="red")
 

G4<-ggplot(subset(l,Recursos_para_distribucion == 2250),aes(x=Delegation,y=Scarcity,colour=factor(Recursos_para_distribucion)))+geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_discrete(labels=names)+
 scale_y_continuous(name = "scarcity [days w/n water]",limits = c(0, 80))+
  scale_color_discrete(name="Resources ",label="100%")+
     annotate("rect", xmin=0, xmax=18, ymin=0 , ymax=20, alpha=0.1, fill="green")+
   annotate("rect", xmin=0, xmax=18, ymin=20 , ymax=40, alpha=0.1,  fill="blue")+
   annotate("rect", xmin=0, xmax=18, ymin=40 , ymax=60, alpha=0.1,  fill="yellow")+   
   annotate("rect", xmin=0, xmax=18, ymin=60 , ymax=80, alpha=0.1, fill="red")
#png(filename = "ranking_escasez.png",width = 18,height = 12,units = "in",res=300)
#multiplot(G4,G3 ,G2,G1, cols = 2)
grid.arrange(G4,G3 ,G2,G1,ncol=2)#ncol=2)

#multiplot(G4,G3 ,G2,G1, cols = 2)
##dev.off()
```

# plot antiguedad results
```{r, echo=FALSE,fig.height=5,fig.width=10}
A<-read.csv(file="C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/concat_output_empirical_antiguedad_scarcity_protestas_C.csv",header = T,skip = 0)
l <- reshape(A, 
  varying = names(A)[19:34], 
  v.names = "Antiguedad", #"Age infrastructure"
  timevar = "Delegation", 
  times = names(A)[19:34], 
  direction = "long")

lp <- reshape(A, 
  varying = names(A)[35:50], 
  v.names = "Water_scarcity", #"Age infrastructure"
  timevar = "Delegation", 
  times = names(A)[35:50], 
  direction = "long")

names<-c("Azcapotzalco","Coyoacán","Cuajimalpa","Gustavo A. Madero","Iztacalco","Iztapalapa","Magdalena Contreras","Milpa Alta","Álvaro Obregón","Tláhuac","Tlalpan","Xochimilco","Benito Juárez","Cuauhtémoc","Miguel Hidalgo","Venustiano Carranza")
ID=c("002","003","004","005","006","007","008","009","010","011","012","013","014","015","016","017")

ggplot(l,aes(x=Delegation,y=Antiguedad,colour=factor(recursos_para_mantenimiento)))+geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_discrete(labels=names)+
  scale_y_continuous(name = "Average age Infrastructure S. [yrs]",breaks = c(0,1000,5000,10000,17000,18000,19000,20000,21000),limits = c(0,21000),labels = round(c(0,1000,5000,10000,17000,18000,19000,20000,21000)/365))+facet_grid(.~Eficiencia_Mantenimiento)


ggplot(lp,aes(x=Delegation,y=Water_scarcity,colour=factor(Recursos_para_distribucion)))+geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_discrete(labels=names)+
  scale_y_continuous(name = "Days with no water",breaks = c(0,10,15,20,25,40,80),limits = c(5,80),labels = c(0,10,15,20,25,40,80))+facet_grid(.~Eficiencia_Mantenimiento)

```




#mapping the number of interventions and age infrastructure for water distribution
```{r, echo=FALSE,fig.height=10,fig.width=20}
studyArea<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/SHV/data/agebs_studyArea")
antiguedad_inicial<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/Layers/Final/antiguedad_v1")
escazes_inicial<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/Layers/Final/escasez_v1")
Munic<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/limites_deleg_DF_2013")
gor=readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/Medicas_ITRF_1992")
gor_df<-as.data.frame(cbind(gor@coords[which(gor@data$TIPO_DE_ES=="CE"),]))

colnames(gor_df)<-c("long","lat")
#generate new variables to add todata frams study area
studyArea@data$antiguedad_inicial=antiguedad_inicial@data$VALUE
studyArea@data$escazes_inicial=escazes_inicial@data$VALUE

studyArea@data$es_C1=numeric(length(escazes_inicial@data$escasez))
studyArea@data$antiguedad_final_L=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$social_pressure_L=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$AB_m_L=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$AB_n_L=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$D_m_L=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$D_n_L=numeric(length(antiguedad_inicial@data$antiguedad))

studyArea@data$es_C2=numeric(length(escazes_inicial@data$escasez))
studyArea@data$antiguedad_final_M=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$social_pressure_M=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$AB_m_M=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$AB_n_M=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$D_m_M=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$D_n_M=numeric(length(antiguedad_inicial@data$antiguedad))

studyArea@data$es_C3=numeric(length(escazes_inicial@data$escasez))
studyArea@data$antiguedad_final_H=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$social_pressure_H=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$AB_m_H=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$AB_n_H=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$D_m_H=numeric(length(antiguedad_inicial@data$antiguedad))
studyArea@data$D_n_H=numeric(length(antiguedad_inicial@data$antiguedad))

studyArea@data$es_C4=numeric(length(escazes_inicial@data$escasez))

#read data from netlogo output text file
studyArea@data$estado<-as.factor(substring(studyArea@data$CVGEO,1,2))
studyArea@data$municipio<-as.factor(substring(studyArea@data$CVGEO,3,5))

#Ant<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/125012000.00500.0050.txt')
#for (i in seq(1,length(Ant),7)){
#studyArea@data$antiguedad_final[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+1] / 365)
#studyArea@data$social_pressure[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+5])
#studyArea@data$escazes_final[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+6])
#}
#high budget
map_a<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/125024000.00500.0050.txt')
for (i in seq(1,length(map_a),13)){
studyArea@data$antiguedad_final_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+1] / 365)
studyArea@data$social_pressure_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+5])
studyArea@data$AB_n_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+8])
studyArea@data$AB_m_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+9])
studyArea@data$D_n_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+11])
studyArea@data$D_m_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+12])
}

map_b<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/125012000.00500.0050.txt')
for (i in seq(1,length(map_b),13)){
studyArea@data$antiguedad_final_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+1] / 365)
studyArea@data$social_pressure_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+5])
studyArea@data$AB_n_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+8])
studyArea@data$AB_m_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+9])
studyArea@data$D_n_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+11])
studyArea@data$D_m_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+12])
}
#low
map_C<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/12502400.00500.0050.txt')
for (i in seq(1,length(map_C),13)){
studyArea@data$antiguedad_final_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+1] / 365)
studyArea@data$social_pressure_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+5])
studyArea@data$AB_n_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+8])
studyArea@data$AB_m_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+9])
studyArea@data$D_n_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+11])
studyArea@data$D_m_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+12])
}


#read scarcity for mapping
map_ac<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-240-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_ac),13)){
studyArea@data$es_C1[which(studyArea@data$AGEB_ID ==map_ac[i])]<-  round(map_ac[i+6])
}

map_bc<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-960-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_bc),13)){
studyArea@data$es_C2[which(studyArea@data$AGEB_ID ==map_bc[i])]<-  round(map_bc[i+6])
}
#low
map_cc<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-1680-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_cc),13)){
studyArea@data$es_C3[which(studyArea@data$AGEB_ID ==map_cc[i])]<-  round(map_cc[i+6])
}

map_dc<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-2400-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_dc),13)){
studyArea@data$es_C4[which(studyArea@data$AGEB_ID ==map_dc[i])]<-  round(map_dc[i+6])
}



studyArea@data<-transform(studyArea@data, z.scarcity_L=cut(studyArea@data$es_C1, breaks=c(0,10,20,40,60)))

studyArea@data<-transform(studyArea@data, z.scarcity_M=cut(studyArea@data$es_C2, breaks=c(0,10,20,40,60)))

studyArea@data<-transform(studyArea@data, z.scarcity_H=cut(studyArea@data$es_C3, breaks=c(0,10,20,40,60)))

studyArea@data<-transform(studyArea@data, z.scarcity_VH=cut(studyArea@data$es_C4, breaks=c(0,10,20,40,60)))



#here we reate new variables to define threshold of based on actions and issue (scarcity or flooding)
studyArea@data<-transform(studyArea@data, z.AB_m_L=cut(studyArea@data$AB_m_L, breaks=c(0,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.AB_n_L=cut(studyArea@data$AB_n_L, breaks=c(0,1,25,50,100,250)))

studyArea@data<-transform(studyArea@data, z.D_m_L=cut(studyArea@data$D_m_L, breaks=c(0,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.D_n_L=cut(studyArea@data$D_n_L, breaks=c(0,1,25,50,100,250)))


studyArea@data<-transform(studyArea@data, z.AB_m_M=cut(studyArea@data$AB_m_M, breaks=c(0,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.AB_n_M=cut(studyArea@data$AB_n_M, breaks=c(0,1,25,50,100,250)))

studyArea@data<-transform(studyArea@data, z.D_m_M=cut(studyArea@data$D_m_M, breaks=c(0,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.D_n_M=cut(studyArea@data$D_n_M, breaks=c(0,1,25,50,100,250)))


studyArea@data<-transform(studyArea@data, z.AB_m_H=cut(studyArea@data$AB_m_H, breaks=c(0,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.AB_n_H=cut(studyArea@data$AB_n_H, breaks=c(0,1,25,50,100,250)))

studyArea@data<-transform(studyArea@data, z.D_m_H=cut(studyArea@data$D_m_H, breaks=c(0,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.D_n_H=cut(studyArea@data$D_n_H, breaks=c(0,1,25,50,100,250)))

writePolyShape(studyArea,"C:/Users/abaezaca/Dropbox (ASU)/MEGADAPT/SHV/outputs/CDMX_vulnerability")
#writeOGR(studyArea,layer="CDMX_vulnerability_prj",dsn = "C:/Users/abaezaca/Dropbox (ASU)/MEGADAPT/SHV/outputs",driver="ESRI Shapefile")
#studyArea@data$antiguedad_diff_M=(studyArea@data$antiguedad_final_M-studyArea@data$antiguedad_inicial)



#cut-offs
#here we reate new variables to define threshold of based on actions and issue (scarcity or flooding)
studyArea@data<-transform(studyArea@data, z.AB_m_L=cut(studyArea@data$AB_m_L, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))
studyArea@data<-transform(studyArea@data, z.AB_n_L=cut(studyArea@data$AB_n_L, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))

studyArea@data<-transform(studyArea@data, z.D_m_L=cut(studyArea@data$D_m_L, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))
studyArea@data<-transform(studyArea@data, z.D_n_L=cut(studyArea@data$D_n_L, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))


studyArea@data<-transform(studyArea@data, z.AB_m_M=cut(studyArea@data$AB_m_M, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))
studyArea@data<-transform(studyArea@data, z.AB_n_M=cut(studyArea@data$AB_n_M, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))

studyArea@data<-transform(studyArea@data, z.D_m_M=cut(studyArea@data$D_m_M, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))
studyArea@data<-transform(studyArea@data, z.D_n_M=cut(studyArea@data$D_n_M, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))


studyArea@data<-transform(studyArea@data, z.AB_m_H=cut(studyArea@data$AB_m_H, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))
studyArea@data<-transform(studyArea@data, z.AB_n_H=cut(studyArea@data$AB_n_H, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))

studyArea@data<-transform(studyArea@data, z.D_m_H=cut(studyArea@data$D_m_H, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))
studyArea@data<-transform(studyArea@data, z.D_n_H=cut(studyArea@data$D_n_H, breaks=c(-10,1,25,50,100,250),labels = c("Very low","Low","Medium","High","Very high")))




colors1 <- colorRampPalette(c( "red","yellow","green","blue","lightblue"))(length(levels(studyArea@data$z.cut5)))
colors2 <- colorRampPalette(c( "red","yellow","blue"))(length(levels(studyArea@data$z.cut3)))
colors4 <- colorRampPalette(c( "lightyellow","yellow","orange","red","darkred"))(length(levels(studyArea@data$z.AB_m_L)))

#fortify data
studyArea@data$id = rownames(studyArea@data)
studyArea.points = fortify(studyArea, region="id")
studyArea.df = join(studyArea.points, studyArea@data, by="id")

#utmcoor_muni<-SpatialPoints(cbind(studyArea.df$lat,studyArea.df$long),proj4string=CRS("+proj=lcc",doCheckCRSArgs = F))
#longlatcoor_muni<-spTransform(utmcoor_muni,CRS("+proj=longlat"))


#read google map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)
ll<-c(-98.9,19,-99.3,19.6)

map<-get_map(location = c(mean(xl),mean(yl)) , maptype = "hybrid",source='google',zoom = 1) #location="Mexico City"
map<-get_map(location = ll , maptype = "hybrid",source='google',zoom = 10) #location="Mexico 

#number of time investment made per ageb (map)
INv_AB_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 

INv_AB_M <- INv_AB_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=AB_m_M, alpha = 0.2))+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_continuous("Vulnerability",low="blue",high="red",limits=c(1,241))


INv_AB_N <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N <- INv_AB_N+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=IAB_new), alpha = 0.2)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_continuous("Vulnerability",low="blue",high="red",limits=c(0,241))


#################
#cut-off plots
INv_AB_M_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_M_cut_L <- INv_AB_M_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_m_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.AB_m_L)))+labs(title="Maintenance   -   S1: Low Budget")


INv_AB_N_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N_cut_L <- INv_AB_N_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_n_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.AB_n_L)))+labs(title="New infra   -   S1: Low Budget")

INv_D_M_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_L <- INv_D_M_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_m_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_m_L)))+labs(title="Maintenance   -   S1: Low Budget")


INv_D_N_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_L <- INv_D_N_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_n_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_n_L)))+labs(title="New infra    -    S1: Low Budget")


######
#medium resources
INv_AB_M_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_M_cut_M <- INv_AB_M_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_m_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.AB_m_M)))+labs(title="S2: Medium")


INv_AB_N_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N_cut_M <- INv_AB_N_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_n_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.AB_n_M)))+labs(title="S2: Medium")

INv_D_M_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_M <- INv_D_M_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_m_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_m_M)))+labs(title="S2: Medium")


INv_D_N_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_M <- INv_D_N_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_n_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_n_M)))+labs(title="S2: Medium")


######
#High resources
INv_AB_M_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_M_cut_H <- INv_AB_M_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_m_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.AB_m_H)))+labs(title="S3: High")


INv_AB_N_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N_cut_H <- INv_AB_N_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_n_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.AB_n_H)))+labs(title="S3: High")

INv_D_M_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_H <- INv_D_M_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_m_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_m_H)))+labs(title="S3: High")


INv_D_N_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_H <- INv_D_N_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_n_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_n_H)))+labs(title="S3: High")

#png(filename = "Vulnerability_INv_D_M_cut_L.png",width = 8,height = 8,units = "in",res=500)

INv_D_M_cut_L
#dev.off()

#png(filename = "Vulnerability_INv_D_M_cut_M.png",width = 8,height = 8,units = "in",res=500)

INv_D_M_cut_M
#dev.off()


#png(filename = "Vulnerability_INv_AB_M_cut_L.png",width = 8,height = 8,units = "in",res=500)

INv_AB_M_cut_L
#dev.off()

#png(filename = "Vulnerability_INv_AB_M_cut_M.png",width = 8,height = 8,units = "in",res=500)

INv_AB_M_cut_M
#dev.off()

##png(filename = "expected_level_of_Vulnerability_10-50per_resources.png",width = 18,height = 8,units = "in",res=500)
#multiplot(INv_AB_M_cut_L, INv_AB_N_cut_L,INv_AB_M_cut_M ,INv_AB_N_cut_M, cols = 2)
##dev.off()

#writeSpatialShape(x = studyArea,fn = "ABM-FR")

##png(filename = "expected_level_of_Vulnerability_10-50per_resources_D.png",width = 18,height = 8,units = "in",res=500)
#multiplot(INv_D_M_cut_L, INv_D_N_cut_L,INv_D_M_cut_M ,INv_D_N_cut_M, cols = 2)
##dev.off()
##png(filename = "expected_level_of_Vulnerability.png",width = 12,height = 12,units = "in",res=300)
#ADiff
##dev.off()

#proposal

#read google map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)
ll<-c(-98.9,19,-99.3,19.6)

map<-get_map(location = c(mean(xl),mean(yl)) , maptype = "hybrid",source='google',zoom = 11) #location="Mexico City"
map<-get_map(location = ll , maptype = "hybrid",source='google',zoom = 10) #location="Mexico 
#create ggplot objects

INv_D_N_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_M <- INv_D_M_cut_M+geom_polygon(data=subset(studyArea.df,estado==levels(studyArea.df$estado)[1]),  aes(x=long,y=lat,group=group,fill=z.D_m_M), alpha = 0.3)+
  geom_path(data=subset(studyArea.df,estado==levels(studyArea.df$estado)[1]),  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .4) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_m_M)))+labs(title="Maintenance")


INv_D_N_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_M <- INv_D_N_cut_M+geom_polygon(data=subset(studyArea.df,estado==levels(studyArea.df$estado)[1]),  aes(x=long,y=lat,group=group,fill=z.D_n_M), alpha = 0.3)+
  geom_path(data=subset(studyArea.df,estado==levels(studyArea.df$estado)[1]),  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .4) +
  scale_fill_manual(name="Vulnerability",values=setNames(colors4, levels(studyArea@data$z.D_n_M)))+labs(title="New Infrastructure")

#png(filename = "C:/Users/abaezaca/Dropbox (ASU)/poposals/expected_level_of_Vulnerability.png",width = 8,height = 4,units = "in",res=400)
multiplot(INv_D_M_cut_M,INv_D_N_cut_M,cols = 2)
#dev.off()
INv_D_M_cut_M
```


```{r, echo=FALSE,fig.height=10,fig.width=20}

H1<-ggplot(data=subset(studyArea@data, estado ==levels(studyArea@data$estado)[1]))+
             geom_histogram(data=subset(studyArea@data,AB_n_L>0),aes(x=AB_n_L),bins = 110,fill="red",alpha=0.8)+
             geom_histogram(data=subset(studyArea@data,AB_n_M>0),aes(x=AB_n_M),fill="green",bins = 110,alpha=0.4)+
             scale_fill_manual(labels=c("V1","V2"))+
             labs(title="Water supply  New-Infra",x="")+theme(text=element_text(size=20))

H2<-ggplot(data=subset(studyArea@data,  estado ==levels(studyArea@data$estado)[1]))+geom_histogram(data=subset(studyArea@data,D_n_L>0),aes(x=D_n_L),bins = 80,fill="red",alpha=0.8)+geom_histogram(data=subset(studyArea@data,D_n_M>0),aes(x=D_n_M),fill="green",bins = 80,alpha=0.4)+scale_colour_manual(name="Error Bars",labels=c("V1","V2"))+labs(title="Drainage",x="# of actions per census block")+theme(text=element_text(size=20),plot.title=element_text())

H3<-ggplot(data=subset(studyArea@data, estado ==levels(studyArea@data$estado)[1]))+geom_histogram(data=subset(studyArea@data,AB_m_L>0),aes(x=AB_m_L),bins = 110,fill="red",alpha=0.8)+geom_histogram(data=subset(studyArea@data,AB_m_M>0),aes(x=AB_m_M),fill="green",bins = 110,alpha=0.4)+scale_fill_manual(labels=c("V1","V2"))+labs(title="Water supply Maintenance",x="")+theme(text=element_text(size=20),plot.title=element_text())

H4<-ggplot(data=subset(studyArea@data,estado ==levels(studyArea@data$estado)[1]))+geom_histogram(data=subset(studyArea@data,D_m_L>0),aes(x=D_m_L),bins = 80,fill="red",alpha=0.8)+geom_histogram(data=subset(studyArea@data,D_m_M>0),aes(x=D_m_M),fill="green",bins = 80,alpha=0.4)+scale_colour_manual(name="Error Bars",labels=c("V1","V2"))+labs(title="Drainage Maintenance",x="# of actions per census block")+theme(text=element_text(size=20),plot.title=element_text())

#png(filename = "histogram_actions.png",width = 15,height = 8,units = "in",res=300)

multiplot(H1,H2,H3,H4,cols = 2)
#dev.off()
```


#results from the entire cuenca
```{r, echo=FALSE,fig.height=10,fig.width=20}
studyArea<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/SHV/data/agebs_studyArea")
antiguedad_inicial<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/MEGADAPT_Integracion/Procesamiento/InputModelos/MBA/13abril2017/antiguedad")
escazes_inicial<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/MEGADAPT_Integracion/Procesamiento/InputModelos/MBA/13abril2017/ESCASEZLCS17a")
Munic<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/limites_deleg_DF_2013")
gor=readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/Medicas_ITRF_1992")
gor_df<-as.data.frame(cbind(gor@coords[which(gor@data$TIPO_DE_ES=="CE"),]))

colnames(gor_df)<-c("long","lat")
#generate new variables to add todata frams study area
studyArea@data$antiguedad_inicial=antiguedad_inicial@data$VALUE
studyArea@data$escazes_inicial=escazes_inicial@data$VALUE

studyArea@data$escazes_final_L=numeric(length(escazes_inicial@data$VALUE))
studyArea@data$antiguedad_final_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$social_pressure_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_m_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_n_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_m_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_n_L=numeric(length(antiguedad_inicial@data$VALUE))

studyArea@data$escazes_final_M=numeric(length(escazes_inicial@data$VALUE))
studyArea@data$antiguedad_final_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$social_pressure_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_m_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_n_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_m_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_n_M=numeric(length(antiguedad_inicial@data$VALUE))

studyArea@data$escazes_final_H=numeric(length(escazes_inicial@data$VALUE))
studyArea@data$antiguedad_final_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$social_pressure_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_m_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_n_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_m_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_n_H=numeric(length(antiguedad_inicial@data$VALUE))

studyArea@data$estado=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$municio=numeric(length(antiguedad_inicial@data$VALUE))
#read data from netlogo output text file
studyArea@data$estado<-as.factor(substring(studyArea@data$CVGEO,1,2))
studyArea@data$municipio<-as.factor(substring(studyArea@data$CVGEO,3,5))

#Ant<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/125012000.00500.0050.txt')
#for (i in seq(1,length(Ant),7)){
#studyArea@data$antiguedad_final[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+1] / 365)
#studyArea@data$social_pressure[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+5])
#studyArea@data$escazes_final[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+6])
#}
#high budget

map_a<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1024012800.0250.025.txt')
for (i in seq(1,length(map_a),13)){
studyArea@data$antiguedad_final_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+1] / 365)
studyArea@data$social_pressure_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+5])
studyArea@data$escazes_final_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+6])
studyArea@data$AB_n_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+8])
studyArea@data$AB_m_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+9])
studyArea@data$D_n_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+11])
studyArea@data$D_m_H[which(studyArea@data$AGEB_ID ==map_a[i])]<-  round(map_a[i+12])
}

map_b<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/102407600.0250.025.txt')
for (i in seq(1,length(map_b),13)){
studyArea@data$antiguedad_final_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+1] / 365)
studyArea@data$social_pressure_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+5])
studyArea@data$escazes_final_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+6])
studyArea@data$AB_n_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+8])
studyArea@data$AB_m_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+9])
studyArea@data$D_n_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+11])
studyArea@data$D_m_M[which(studyArea@data$AGEB_ID ==map_b[i])]<-  round(map_b[i+12])
}
#low
map_C<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/102402400.0250.025.txt')
for (i in seq(1,length(map_C),13)){
studyArea@data$antiguedad_final_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+1] / 365)
studyArea@data$social_pressure_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+5])
studyArea@data$escazes_final_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+6])
studyArea@data$AB_n_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+8])
studyArea@data$AB_m_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+9])
studyArea@data$D_n_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+11])
studyArea@data$D_m_L[which(studyArea@data$AGEB_ID ==map_C[i])]<-  round(map_C[i+12])
}




#here we reate new variables to define threshold of based on actions and issue (scarcity or flooding)
studyArea@data<-transform(studyArea@data, z.AB_m_L=cut(studyArea@data$AB_m_L, breaks=c(-10,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.AB_n_L=cut(studyArea@data$AB_n_L, breaks=c(-10,1,25,50,100,250)))

studyArea@data<-transform(studyArea@data, z.D_m_L=cut(studyArea@data$D_m_L, breaks=c(-10,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.D_n_L=cut(studyArea@data$D_n_L, breaks=c(-10,1,25,50,100,250)))


studyArea@data<-transform(studyArea@data, z.AB_m_M=cut(studyArea@data$AB_m_M, breaks=c(-10,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.AB_n_M=cut(studyArea@data$AB_n_M, breaks=c(-10,1,25,50,100,250)))

studyArea@data<-transform(studyArea@data, z.D_m_M=cut(studyArea@data$D_m_M, breaks=c(-10,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.D_n_M=cut(studyArea@data$D_n_M, breaks=c(-10,1,25,50,100,250)))


studyArea@data<-transform(studyArea@data, z.AB_m_H=cut(studyArea@data$AB_m_H, breaks=c(-10,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.AB_n_H=cut(studyArea@data$AB_n_H, breaks=c(-10,1,25,50,100,250)))

studyArea@data<-transform(studyArea@data, z.D_m_H=cut(studyArea@data$D_m_H, breaks=c(-10,1,25,50,100,250)))
studyArea@data<-transform(studyArea@data, z.D_n_H=cut(studyArea@data$D_n_H, breaks=c(-10,1,25,50,100,250)))




colors4 <- colorRampPalette(c( "lightblue","blue","green","yellow","red"))(length(levels(studyArea@data$z.AB_m_L)))

#fortify data
studyArea@data$id = rownames(studyArea@data)
studyArea.points = fortify(studyArea, region="id")
studyArea.df = join(studyArea.points, studyArea@data, by="id")

#utmcoor_muni<-SpatialPoints(cbind(studyArea.df$lat,studyArea.df$long),proj4string=CRS("+proj=lcc",doCheckCRSArgs = F))
#longlatcoor_muni<-spTransform(utmcoor_muni,CRS("+proj=longlat"))


#read google map
xl=c(-98.8, -99.4)
yl=c(19, 19.8)
map<-get_map(location = c(mean(xl),mean(yl)) , maptype = "hybrid",source='google') #location="Mexico City"





#################
#cut-off plots
INv_AB_M_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_M_cut_L <- INv_AB_M_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_m_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.AB_m_L)))+labs(title="Maintenance   -   S1: Low Budget")


INv_AB_N_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N_cut_L <- INv_AB_N_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_n_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.AB_n_L)))+labs(title="New infra   -   S1: Low Budget")

INv_D_M_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_L <- INv_D_M_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_m_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.D_m_L)))+labs(title="Maintenance   -   S1: Low Budget")


INv_D_N_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_L <- INv_D_N_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_n_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.D_n_L)))+labs(title="New infra    -    S1: Low Budget")


######
#medium resources
INv_AB_M_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_M_cut_M <- INv_AB_M_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_m_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.AB_m_M)))+labs(title="S2: Medium")


INv_AB_N_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N_cut_M <- INv_AB_N_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_n_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.AB_n_M)))+labs(title="S2: Medium")

INv_D_M_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_M <- INv_D_M_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_m_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.D_m_M)))+labs(title="S2: Medium")


INv_D_N_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_M <- INv_D_N_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_n_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.D_n_M)))+labs(title="S2: Medium")


######
#High resources
INv_AB_M_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_M_cut_H <- INv_AB_M_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_m_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.AB_m_H)))+labs(title="S3: High")


INv_AB_N_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_AB_N_cut_H <- INv_AB_N_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.AB_n_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.AB_n_H)))+labs(title="S3: High")

INv_D_M_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_M_cut_H <- INv_D_M_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_m_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.D_m_H)))+labs(title="S3: High")


INv_D_N_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
INv_D_N_cut_H <- INv_D_N_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.D_n_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="# of actions",values=setNames(colors4, levels(studyArea@data$z.D_n_H)))+labs(title="S3: High")

#png(filename = "Vulnerability_INv_D_M_cut_L.png",width = 8,height = 8,units = "in",res=500)

INv_D_M_cut_L
#dev.off()

#png(filename = "Vulnerability_INv_D_M_cut_M.png",width = 8,height = 8,units = "in",res=500)

INv_D_M_cut_M
#dev.off()


#png(filename = "Vulnerability_INv_AB_M_cut_L.png",width = 8,height = 8,units = "in",res=500)

INv_AB_M_cut_L
#dev.off()

#png(filename = "Vulnerability_INv_AB_M_cut_M.png",width = 8,height = 8,units = "in",res=500)

INv_AB_M_cut_M
#dev.off()

```



#First analyses/results water scarcity
```{r, echo=FALSE,fig.height=10,fig.width=20}
studyArea@data$escazes_diff_M=(studyArea@data$escazes_inicial - studyArea@data$es_C1)

  studyArea@data<-transform(studyArea@data, z.cut6=cut(escazes_final_M, breaks=c(-1,10,15,20,30,110),labels = c("very-low","low","medium","high","very-high")))

colors3 <- colorRampPalette(c("lightblue","blue","green", "yellow", "red"))(length(levels(studyArea@data$z.cut6)))




WSI_M<-ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) + 
  geom_polygon(data=studyArea.df,aes(long,lat,group=group,fill=escazes_final_M),alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8)  +
  coord_equal() +
  scale_fill_continuous("Age Water supply Infrastructure",low="blue",high="red",limits=c(0,60))



ADiff_scarcity <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
ADiff_scarcity <- ADiff_scarcity+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.cut6, alpha = 0.2))+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="Level of investment",values=setNames(colors3, levels(studyArea@data$z.cut6)))+labs(title="Expected level of scarcity")




#+ scale_fill_continuous("Age Water supply Infrastructure",low="blue",high="red",limits=c(-32,20))

#png(filename = "scarcity_vs_Vulnerability.png",width = 18,height = 12,units = "in",res=500)
multiplot(ADiff,ADiff_scarcity, cols = 2)
#dev.off()
#png(filename = "expected_level_of_scarcity.png",width = 12,height = 12,units = "in",res=300)
ADiff_scarcity
#dev.off()
```
#comparison intervention income
```{r, echo=FALSE,fig.height=10,fig.width=20}
income_index<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/MEGADAPT_Integracion/Procesamiento/InputModelos/MBA/13abril2017/AGEB_ingreso")


DD<-subset(studyArea@data,estado==levels(studyArea@data$estado)[1]& Indx > 0)

levels(DD$municipio)
studyArea@data$Indx<-income_index@data$VALUE
P1<-ggplot(data=DD)+geom_point(aes(x=AB_m_M,y=Indx,colour=municipio))+geom_smooth(aes(x=AB_m_M,y=Indx),span=1.5,method = "lm")+scale_color_discrete(labels=names)+facet_wrap(~municipio)+theme(text=element_text(size=20))

P2<-ggplot(data=subset(studyArea@data,estado==levels(studyArea@data$estado)[1] & Indx > 0))+geom_point(aes(x=AB_m_M,y=Indx,colour=municipio),size=2)+geom_smooth(aes(x=AB_m_M,y=Indx),span=1.5,method = "lm")+scale_color_discrete(labels=names)+labs(x="# of actions",y="Income Index",size=20)+theme(text=element_text(size=20))


#png(filename = "incomeIndex_vs_Vulnerability.png",width = 15,height = 8,units = "in",res=500)
P2
#dev.off()

#png(filename = "incomeIndex_vs_Vulnerability_bydelegation.png",width = 18,height = 8,units = "in",res=500)
P1
#dev.off()

```


Social pressure
```{r, echo=FALSE,fig.height=10,fig.width=20}
studyArea@data$social_pressure_L[which(studyArea@data$estado!="09")]<-0


  studyArea@data<-transform(studyArea@data, z.cut7=cut(social_pressure_L, breaks=c(100,150,200,280),labels = c("low","medium","high")))

colors2 <- colorRampPalette(c("blue","yellow", "red"))(length(levels(studyArea@data$z.cut7)))

studyArea@data$id = rownames(studyArea@data)
studyArea.points = fortify(studyArea, region="id")
studyArea.df = join(studyArea.points, studyArea@data, by="id")




SP<-ggplot(studyArea.df) + 
  aes(long,lat,group=group,fill=social_pressure_L) + 
  geom_polygon() +
  geom_path(color="white") +
  coord_equal() +
  scale_fill_manual(name="social pressure",values=setNames(colors2, levels(studyArea@data$z.cut7)))+labs(title="social pressure")

SP
```

```{r, echo=FALSE,fig.height=10,fig.width=20}
studyArea<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/SHV/data/agebs_studyArea")
Munic<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/limites_deleg_DF_2013")
gor=readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/Medicas_ITRF_1992")
gor_df<-as.data.frame(cbind(gor@coords[which(gor@data$TIPO_DE_ES=="CE"),]))

colnames(gor_df)<-c("long","lat")
#generate new variables to add todata frams study area
studyArea@data$d_R_Comp=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_R_Cap=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_R_Mov=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_R_AC=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_R_Mod=numeric(length(studyArea@data$POB_S_AGUA))


studyArea@data$d_WOA_mant=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_WOA_new=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_WOA_Dist=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_WOA_extr=numeric(length(studyArea@data$POB_S_AGUA))

studyArea@data$d_WOD_mant=numeric(length(studyArea@data$POB_S_AGUA))
studyArea@data$d_WOD_new=numeric(length(studyArea@data$POB_S_AGUA))


map_C<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/distance_ideal.txt')
for (i in seq(1,length(map_C),12)){
studyArea@data$d_R_Comp[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+1]
studyArea@data$d_R_Cap[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+2]
studyArea@data$d_R_Mov[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+3]
studyArea@data$d_R_AC[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+4]
studyArea@data$d_R_Mod[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+5]
studyArea@data$d_WOA_mant[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+6]
studyArea@data$d_WOA_new[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+7]
studyArea@data$d_WOA_Dist[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+8]
studyArea@data$d_WOA_extr[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+9]
studyArea@data$d_WOD_mant[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+10]
studyArea@data$d_WOD_new[which(studyArea@data$AGEB_ID ==map_C[i])]<-  map_C[i+11]
}
studyArea@data$estado<-as.factor(substring(studyArea@data$CVGEO,1,2))
studyArea@data$municipio<-as.factor(substring(studyArea@data$CVGEO,3,5))

studyArea@data$d_R_Mov[which(studyArea@data$estado!="09")]<-0
studyArea@data<-transform(studyArea@data, z.d_R_M=cut(studyArea@data$d_R_Mov, breaks=c(0.00001,0.025,0.028,0.03),labels = c("low","medium","high")))
colors2 <- colorRampPalette(c( "blue","yellow","red"))(length(levels(studyArea@data$z.d_R_M)))


studyArea@data$id = rownames(studyArea@data)
studyArea.points = fortify(studyArea, region="id")
studyArea.df = join(studyArea.points, studyArea@data, by="id")

#utmcoor_muni<-SpatialPoints(cbind(studyArea.df$lat,studyArea.df$long),proj4string=CRS("+proj=lcc",doCheckCRSArgs = F))
#longlatcoor_muni<-spTransform(utmcoor_muni,CRS("+proj=longlat"))


#read google map
xl=c(-98.8, -99.4)
yl=c(19, 19.8)
map<-get_map(location = c(mean(xl),mean(yl)) , maptype = "hybrid",source='google') #location="Mexico City"



d_R_Mov <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
d_R_Mov <- d_R_Mov+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=d_R_Mov), alpha = 0.2)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_continuous("Vulnerability",low="blue",high="red",limits=range(studyArea@data$d_R_Mov))

SP<-ggplot(studyArea.df) + 
  aes(long,lat,group=group,fill=z.d_R_M) + 
  geom_polygon() +
  geom_path(color="white") +
  coord_equal() +
  scale_fill_manual(name="social pressure",values=setNames(colors2, levels(studyArea@data$z.d_R_M)))+labs(title="social pressure")+theme(text=element_text(size=20))



d_R_AC <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
d_R_AC <- d_R_AC+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=d_R_AC), alpha = 0.2)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_continuous("Vulnerability",low="blue",high="red",limits=c(0.00001,max(studyArea@data$d_R_AC,na.rm = T)))



#png(filename = "social_pressure.png",width = 12,height = 12,units = "in",res=300)

SP
#dev.off()


d_R_AC
```






#mapping water scarcity in space
```{r, echo=FALSE,fig.height=10,fig.width=20}
studyArea<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/SHV/data/agebs_studyArea")
antiguedad_inicial<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/Layers/Final/antiguedad_v1")
escazes_inicial<-readShapeSpatial("C:/Users/abaezaca/Dropbox (ASU)/Layers/Final/escasez_v1")
Munic<-readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/limites_deleg_DF_2013")
gor=readShapeSpatial("C:/Users/abaezaca/Documents/MEGADAPT/GIS_layers/Medicas_ITRF_1992")
gor_df<-as.data.frame(cbind(gor@coords[which(gor@data$TIPO_DE_ES=="CE"),]))

colnames(gor_df)<-c("long","lat")
#generate new variables to add todata frams study area
studyArea@data$antiguedad_inicial=antiguedad_inicial@data$VALUE
studyArea@data$escazes_inicial=escazes_inicial@data$VALUE

studyArea@data$escazes_final_L=numeric(length(escazes_inicial@data$VALUE))
studyArea@data$antiguedad_final_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$social_pressure_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_m_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_n_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_m_L=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_n_L=numeric(length(antiguedad_inicial@data$VALUE))

studyArea@data$escazes_final_M=numeric(length(escazes_inicial@data$VALUE))
studyArea@data$antiguedad_final_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$social_pressure_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_m_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_n_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_m_M=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_n_M=numeric(length(antiguedad_inicial@data$VALUE))

studyArea@data$escazes_final_H=numeric(length(escazes_inicial@data$VALUE))
studyArea@data$antiguedad_final_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$social_pressure_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_m_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$AB_n_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_m_H=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$D_n_H=numeric(length(antiguedad_inicial@data$VALUE))

studyArea@data$estado=numeric(length(antiguedad_inicial@data$VALUE))
studyArea@data$municio=numeric(length(antiguedad_inicial@data$VALUE))
#read data from netlogo output text file
studyArea@data$estado<-as.factor(substring(studyArea@data$CVGEO,1,2))
studyArea@data$municipio<-as.factor(substring(studyArea@data$CVGEO,3,5))

#Ant<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/125012000.00500.0050.txt')
#for (i in seq(1,length(Ant),7)){
#studyArea@data$antiguedad_final[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+1] / 365)
#studyArea@data$social_pressure[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+5])
#studyArea@data$escazes_final[which(studyArea@data$AGEB_ID ==Ant[i])]<-  round(Ant[i+6])
#}
#high budget
map_ac<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-240-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_ac),13)){
studyArea@data$es_C1[which(studyArea@data$AGEB_ID ==map_ac[i])]<-  round(map_ac[i+6])
}

map_bc<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-960-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_bc),13)){
studyArea@data$es_C2[which(studyArea@data$AGEB_ID ==map_bc[i])]<-  round(map_bc[i+6])
}
#low
map_cc<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-1680-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_cc),13)){
studyArea@data$es_C3[which(studyArea@data$AGEB_ID ==map_cc[i])]<-  round(map_cc[i+6])
}

map_dc<-scan(file = 'C:/Users/abaezaca/Documents/MEGADAPT/SHV/outputs/1-2400-240-240-0.025-0.025.txt')
for (i in seq(1,length(map_dc),13)){
studyArea@data$es_C3[which(studyArea@data$AGEB_ID ==map_dc[i])]<-  round(map_dc[i+6])
}



studyArea@data<-transform(studyArea@data, z.scarcity_L=cut(studyArea@data$es_C1, breaks=c(0,10,20,40,60)))

studyArea@data<-transform(studyArea@data, z.scarcity_M=cut(studyArea@data$es_C2, breaks=c(0,10,20,40,60)))

studyArea@data<-transform(studyArea@data, z.scarcity_H=cut(studyArea@data$es_C3, breaks=c(0,10,20,40,60)))

studyArea@data<-transform(studyArea@data, z.scarcity_VH=cut(studyArea@data$es_C4, breaks=c(0,10,20,40,60)))



colors4 <- colorRampPalette(c( "lightblue","blue","green","yellow","red"))(length(levels(studyArea@data$z.scarcity_M)))

#fortify data
studyArea@data$id = rownames(studyArea@data)
studyArea.points = fortify(studyArea, region="id")
studyArea.df = join(studyArea.points, studyArea@data, by="id")

#utmcoor_muni<-SpatialPoints(cbind(studyArea.df$lat,studyArea.df$long),proj4string=CRS("+proj=lcc",doCheckCRSArgs = F))
#longlatcoor_muni<-spTransform(utmcoor_muni,CRS("+proj=longlat"))


#read google map
xl=c(-98.8, -99.4)
yl=c(19, 19.8)
map<-get_map(location = c(mean(xl),mean(yl)) , maptype = "hybrid",source='google') #location="Mexico City"

#create ggplot objects
#cut-off plots
scarcity_cut_L <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
scarcity_cut_L <- scarcity_cut_L+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.scarcity_L), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="days w/n water",values=setNames(colors4, levels(studyArea@data$z.scarcity_cut_L)))+labs(title="Water Scarcity   -   S1: Budget  [10% CB]")

scarcity_cut_M <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
scarcity_cut_M <- scarcity_cut_M+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.scarcity_M), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="days w/n water",values=setNames(colors4, levels(studyArea@data$z.scarcity_cut_M)))+labs(title="Water Scarcity   -   S2: Budget [25% CB] ")


scarcity_cut_H <- ggmap(map, base_layer=ggplot(data=gor_df, aes(x=long,y=lat)),extent = "normal", maprange=FALSE) 
scarcity_cut_H <- scarcity_cut_H+geom_polygon(data=studyArea.df,  aes(x=long,y=lat,group=group,fill=z.scarcity_H), alpha = 0.3)+
  geom_path(data=studyArea.df,  aes(x=long,y=lat,group=id),color="white",size=0.05)+
   geom_path(aes(x = long, y = lat, group=id), data = fortify(Munic),colour = 'black', size = .8) +
  scale_fill_manual(name="days w/n water",values=setNames(colors4, levels(studyArea@data$z.scarcity_cut_H)))+labs(title="Water Scarcity   -   S3: Budget [50% CB] ")



#png(filename = "scarcity_cut_L.png",width = 8,height = 8,units = "in",res=500)

scarcity_cut_L
#dev.off()

#png(filename = "scarcity_cut_M.png",width = 8,height = 8,units = "in",res=500)

scarcity_cut_M
#dev.off()

#png(filename = "scarcity_cut_H.png",width = 8,height = 8,units = "in",res=500)

scarcity_cut_H
#dev.off()


H1<-ggplot(data=subset(studyArea@data, estado ==levels(studyArea@data$estado)[1]))+
             geom_histogram(aes(x=escazes_final_L),fill="red",bins = 80,alpha=0.8)+
             geom_histogram(aes(x=escazes_final_M),fill="green",bins = 80,alpha=0.6)+
               geom_histogram(aes(x=escazes_final_H),fill="blue",bins = 80,alpha=0.3)+
             labs(title="Water supply",x="days w/n water")+theme(text=element_text(size=20))


#png(filename = "ewater_scarcity_histograms.png",width = 12,height = 8,units = "in",res=500)
H1
#dev.off()

#writeSpatialShape(x = studyArea,fn = "ABM-FR")

##png(filename = "expected_level_of_Vulnerability_10-50per_resources_D.png",width = 18,height = 8,units = "in",res=500)
#multiplot(INv_D_M_cut_L, INv_D_N_cut_L,INv_D_M_cut_M ,INv_D_N_cut_M, cols = 2)
##dev.off()
##png(filename = "expected_level_of_Vulnerability.png",width = 12,height = 12,units = "in",res=300)
#ADiff
##dev.off()
INv_D_M_cut_M
```