#Indicators of Vulnerability
require(leaflet)
Initial_outcome=subset(TS_res,year_sim==2020)
final_outcome=subset(TS_res,year_sim==2038) #indicate final year for outcome  

Final_Outcome=studyArea_CVG



Final_Outcome@data=final_outcome

#show results as map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)
############################################################
##colors pals
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$vulnerability_D
)

pal_infra <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$antiguedad_Ab
)

pal_flood <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$encharca
)

pal_adaptation_AB <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$sensitivity_Ab
)

pal_adaptation_D <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$sensitivity_D
)
pal_adaptation_D<-colorBin(
  palette = "Blues",
  domain = Final_Outcome$sensitivity_D,bins = 5)
qpal <- colorQuantile("Blues", Final_Outcome$encharca)

############################################################
m <- leaflet(data=Final_Outcome) %>%
  addTiles(group = "Indicators of Vulnerability") %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-99.1398, lat=19.4249,popup="Mexico City") %>%
  addPolygons(fillColor = "transparent", stroke = FALSE,group = "Mapa Base") %>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~colorFactor("YlOrRd", antiguedad_D)(antiguedad_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Infrastructure")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~colorQuantile("YlOrRd", vulnerability_D)(vulnerability_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Vulnerability")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~qpal(encharca),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Flooding")%>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_AB(sensitivity_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Adaptation_W")%>%
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_D(sensitivity_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Adaptation_D")%>%
  
  setView(lng=mean(xl), lat=mean(yl), zoom = 10) %>%
  
#############legends######################################
  addLegend("bottomright", pal = pal, values = ~vulnerability_D,
            title = "Vulnerability Drainage",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Vulnerability"
  )%>%
  addLegend("bottomright", pal = pal_infra, values = ~antiguedad_Ab,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure"
  )%>%
  addLegend("bottomright", pal = qpal, values = ~encharca,
            title = "Flooding",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Flooding"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_AB, values = ~sensitivity_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_W"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_D, values = ~sensitivity_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_D"
  )%>%
#####control############
  addLayersControl(
  baseGroups = c("Mapa Base"),
  overlayGroups = c("Vulnerability", "Infrastructure","Flooding","Scarcity","Adaptation_W","Adaptation_D"),
  options = layersControlOptions(collapsed = FALSE)
)%>%
hideGroup(c("Vulnerability","Infrastructure","Scarcity","Flooding","Adaptation_W","Adaptation_D"))
print(m)
