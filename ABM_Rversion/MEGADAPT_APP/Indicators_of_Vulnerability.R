#Indicators of Vulnerability
require(leaflet)
Initial_outcome=subset(TS_res,year_sim==2020)
final_outcome=subset(TS_res,year_sim==2038) #indicate final year for outcome  

Final_Outcome=studyArea_CVG



Final_Outcome@data=final_outcome

#show results as map
xl=c(-98.9, -99.3)
yl=c(19, 19.6)

####################Labels for hihglights
labels_flood <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g events",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$encharca)
) %>% lapply(htmltools::HTML)

labels_scarcity <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g average days/week",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$NOWater_week_pois)
) %>% lapply(htmltools::HTML)

labels_gov_interventions_D <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$Interventions_D)
) %>% lapply(htmltools::HTML)

labels_gov_interventions_Ab <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$Interventions_Ab)
) %>% lapply(htmltools::HTML)

labels_protest <- sprintf(
  "<strong>%s</strong><br/>%g ID / %g interventions",
  Final_Outcome$AGEB_ID,Final_Outcome$municipio,round(Final_Outcome$social_pressure)
) %>% lapply(htmltools::HTML)

############################################################
##colors pals
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$vulnerability_D
)

pal_infra <- colorNumeric(
  palette = "YlOrRd",
  domain = Final_Outcome$antiguedad_Ab
)

pal_flood <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$encharca
)
pal_scarcity <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$NOWater_week_pois
)
pal_adaptation_AB <- colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$sensitivity_Ab,
  reverse = T
)

pal_adaptation_D <- colorNumeric(
  palette = "Blues",
  domain = Final_Outcome$sensitivity_D,
  reverse = T
  
)
pal_adaptation_D<-colorBin(
  palette = "Blues",
  domain = Final_Outcome$sensitivity_D)
qpal <- colorQuantile("Blues", Final_Outcome$encharca)

pal_interventions_D<-colorBin(
  palette = "Blues",
  domain = Final_Outcome$Interventions_D)

pal_interventions_Ab<-colorBin(
  palette = "Reds",
  domain = Final_Outcome$Interventions_Ab)

pal_protests<-colorNumeric(
  palette = "Reds",
  domain = Final_Outcome$social_pressure)

############################################################
m <- leaflet(data=Final_Outcome) %>%
  addTiles("Indicators of Vulnerability") %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-99.1398, lat=19.4249,popup="Mexico City") %>%
  addPolygons(fillColor = "transparent", stroke = FALSE,group = "Mapa Base") %>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_infra(antiguedad_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Infrastructure")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
             opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~colorQuantile("YlOrRd", vulnerability_D)(vulnerability_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Vulnerability_D")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~qpal(encharca),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE
                                                  ),
              group = "Flooding",
              label = labels_flood)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_scarcity(NOWater_week_pois),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Scarcity",
              label=labels_scarcity)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_AB(sensitivity_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Adaptation_W")%>%
  
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_adaptation_D(sensitivity_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),group = "Adaptation_D")%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_D(Interventions_D),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_D",
              label=labels_gov_interventions_D)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_interventions_Ab(Interventions_Ab),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Interventions_W",
              label=labels_gov_interventions_Ab)%>%
  
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5,
              fillColor = ~pal_protests(social_pressure),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE),
              group = "Social_Pressure",
              label=labels_protest)%>%
    
  setView(lng=mean(xl), lat=mean(yl), zoom = 10) %>%
  
#############legends######################################
  addLegend("bottomright", pal = pal, values = ~vulnerability_D,
            title = "Vulnerability Drainage",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Vulnerability_D"
  )%>%
  addLegend("bottomright", pal = pal_infra, values = ~antiguedad_Ab,
            title = "Infrastructure",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Infrastructure"
  )%>%
  addLegend("bottomright", pal = qpal, values = ~encharca,
            title = "Flooding",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Flooding"
  )%>%
  addLegend("bottomright", pal = pal_scarcity, values = ~NOWater_week_pois,
            title = " Water Scarcity [days/weeks]",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Scarcity"
  )%>%
  
  addLegend("bottomright", pal = pal_adaptation_AB, values = ~sensitivity_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_W"
  )%>%
  addLegend("bottomright", pal = pal_adaptation_D, values = ~sensitivity_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Adaptation_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_D, values = ~Interventions_D,
            title = "# actions residents D",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_D"
  )%>%
  addLegend("bottomright", pal = pal_interventions_Ab, values = ~Interventions_Ab,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Interventions_W"
  )%>%
  
  addLegend("bottomright", pal = pal_protests, values = ~social_pressure,
            title = "# actions residents W",
            labFormat = labelFormat(prefix = ""),
            opacity = 1,group = "Social_Pressure"
  )%>%
#####control############
  addLayersControl(
  baseGroups = c("Mapa Base"),
  overlayGroups = c("Vulnerability_D", "Infrastructure","Flooding","Scarcity","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"),
  options = layersControlOptions(collapsed = FALSE)
)%>%
hideGroup(c("Vulnerability_D","Infrastructure","Scarcity","Flooding","Adaptation_W","Adaptation_D","Interventions_D","Interventions_W","Social_Pressure"))
print(m)
